# blamebot

**Provenance tracking for AI-authored code.** `git blame` tells you *who* and *when*. `git blamebot` tells you *why* — the user prompt and reasoning behind every AI edit.

This is very similar in concept to the more mature [Git AI](https://usegitai.com/) but with a focus on detailed line-level reasoning.

## How it works

Three Claude Code hooks capture context on every AI edit:

1. **`PreToolUse`** on `Edit/Write/MultiEdit` — snapshots the file *before* the edit (checkpoint for attribution tracking)
2. **`PostToolUse`** on `Edit/Write/MultiEdit` — records what changed: file, precise changed lines (via LCS diffing), content hash, hunk metadata, and a compact diff summary. Also snapshots the file *after* the edit.
3. **`UserPromptSubmit`** — captures your prompt (with IDE metadata stripped) and stashes it for the edit hooks

At **commit time**, a `commit-msg` hook:
- Bundles all pending edits into a **manifest** (one JSON file per commit)
- Fills in a one-sentence reason per edit using Claude Haiku (from the session transcript)
- Computes **checkpoint-based attribution** — exact per-line ownership by diffing pre/post snapshots
- Writes the manifest and traces to the `blamebot-provenance` branch (no working tree pollution)
- Appends a `Blamebot-Ref: <manifest-id>` trailer to the commit message

### Checkpoint-based attribution

The key innovation over forward simulation: by snapshotting the file before and after each AI edit, blamebot can track exactly which lines belong to which edit — even when manual edits split, shift, or interleave with AI content. At commit time, LCS diffing walks the checkpoint chain to build a precise attribution map.

### What gets recorded

Each edit captures three layers of "why":

- **Prompt**: Your original request
- **Reason**: A one-sentence explanation generated by Haiku from the session transcript and prompt history (filled at commit time)
- **Change**: A compact `old → new` diff summary
- **Trace**: `transcript_path#tool_use_id` — use `--trace` to view the agent's full thinking/response, or `--explain` for a Sonnet-generated deep explanation

## Setup

### One-time global install

```bash
make install
```

Builds the `git-blamebot` binary, installs it to `~/.local/bin/`, and configures Claude Code hooks (`PreToolUse`, `PostToolUse`, `UserPromptSubmit`) in `~/.claude/settings.json`.

### Per-repo init

```bash
cd your-project && git-blamebot enable
```

Creates the `blamebot-provenance` branch, local cache at `.git/blamebot/`, and installs git hooks (`commit-msg`, `post-commit`, `pre-push`).

## CLI usage

```bash
git blamebot src/main.go                  # current AI edits in a file
git blamebot src/main.go -L 42            # most recent reason for a line
git blamebot -L 10,20 src/main.go         # line range
git blamebot --include-history src/main.go # include superseded/overwritten edits
git blamebot --grep "timeout"             # search prompts, reasons & changes
git blamebot --since 2025-02-17           # filter by date
git blamebot --author jens                # filter by author
git blamebot --trace 7                    # show full reasoning trace for record #7
git blamebot --explain src/main.go -L 42  # deep explanation via Sonnet
git blamebot --explain 7                  # explain a specific record by ID
git blamebot --stats                      # summary statistics
git blamebot --json src/main.go           # machine-readable JSON output
git blamebot -v src/main.go               # verbose: diff, hashes, sessions, git blame
```

By default, only edits with lines still present in the current file are shown (like `git blame`). Use `--include-history` to see overwritten and superseded edits too.

### Maintenance

```bash
git blamebot --fill-reasons               # fill empty reasons (runs automatically at commit time)
git blamebot --fill-reasons --dry-run     # preview what would be generated
git blamebot --rebuild                    # force SQLite index rebuild
git-blamebot disable                      # remove tracking from this repo
```

### Debug commands

```bash
git-blamebot debug insert README.md -m 5 -n 3 --as-agent   # simulate AI insert
git-blamebot debug replace src/main.go -m 10 -n 2          # simulate manual replace
git-blamebot debug remove README.md -m 3 -n 1 --as-agent   # simulate AI delete
git blamebot --log                                          # hook log
git blamebot --log --hook                                   # PostToolUse hook log
git blamebot --dump-payload                                 # last raw payloads
```

The `debug` commands modify files and optionally register edits as AI-authored (`--as-agent`), useful for testing the attribution pipeline without an actual AI agent.

## Data storage

Provenance data lives on a dedicated `blamebot-provenance` branch — never in your working tree. This means:
- No `.blamebot/` directory polluting diffs or `git status`
- Clean merges (the provenance branch is append-only)
- Data travels with the repo when pushed/pulled

```
blamebot-provenance branch:
├── manifests/<id>.json         # one per commit with AI edits
└── traces/<session>.json       # extracted thinking/response blocks

<repo>/.git/blamebot/           # LOCAL ONLY — query cache + ephemeral state
├── index.db                    # SQLite (auto-rebuilt from manifests)
├── pending/<id>.json           # uncommitted edits (cleared at commit time)
├── checkpoints/                # pre/post-edit file snapshots (cleared at commit time)
│   ├── <id>.json               # checkpoint metadata
│   └── blobs/<sha256>          # file content snapshots (deduplicated)
├── current_prompt.json         # ephemeral state between hooks
└── logs/                       # debug logs
```

### Manifest format

Each commit with AI edits produces a manifest:

```json
{
  "id": "a1b2c3d4-...",
  "commit_sha": "abc1234",
  "author": "Jens",
  "timestamp": "2026-02-25T14:23:13Z",
  "edits": [
    {
      "file": "app/pages/editor/index.php",
      "lines": "5,7",
      "content_hash": "be40cdf0917128af",
      "prompt": "Change all messages to 90s cool kid speak",
      "reason": "Updated error messages to use 90s slang as requested.",
      "change": "'error' => 'Title is required' → 'error' => 'Title is required, dude!'",
      "tool": "Edit",
      "session": "9257ef4a-...",
      "hunk": {"old_start": 5, "old_lines": 2, "new_start": 5, "new_lines": 2}
    }
  ],
  "attributions": {
    "app/pages/editor/index.php": {
      "edit_lines": { "0": "5-7" }
    }
  }
}
```

The `attributions` field maps files to per-edit line ownership at commit time, enabling accurate tracking even after subsequent manual edits.

## Building from source

```bash
make build    # build to dist/git-blamebot
make test     # run tests
make install  # build + install + configure hooks
```

Requires Go 1.24+. No CGO — the binary is fully static and cross-compilable.

## Future ideas

See [FUTURE_WORK.md](FUTURE_WORK.md) for potential improvements and features.
