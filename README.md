# blamebot

**Provenance tracking for AI-authored code.** `git blame` tells you *who* and *when*. `git blamebot` tells you *why* — the user prompt and reasoning behind every AI edit.

This is very similar in concept to the more mature [Git AI](https://usegitai.com/) but with a focus on detailed line-level reasoning.

## How it works

Two Claude Code hooks capture context on every AI edit:

1. **`UserPromptSubmit`** — captures your prompt (with IDE metadata stripped) and stashes it for the edit hook
2. **`PostToolUse`** on `Edit/Write/MultiEdit` — records what changed: file, precise changed lines (via LCS diffing), content hash, hunk metadata, and a compact diff summary

At **commit time**, a pre-commit hook calls `git-blamebot --fill-reasons`, which reads the Claude transcript for each edit and sends the session context to Claude Haiku to generate a one-sentence reason per edit. It also extracts and commits trace contexts (thinking/response blocks) so they're portable across machines.

### What gets recorded

Each record captures three layers of "why":

- **Prompt**: Your original request
- **Reason**: A one-sentence explanation generated by Haiku from the session transcript and prompt history (filled at commit time)
- **Change**: A compact `old → new` diff summary
- **Trace**: `transcript_path#tool_use_id` — use `--trace` to view the agent's full thinking/response, or `--explain` for a Sonnet-generated deep explanation

## Setup

### One-time global install

```bash
make install
```

Builds the `git-blamebot` binary, installs it to `~/.local/bin/`, and configures Claude Code hooks in `~/.claude/settings.json`.

### Per-repo init

```bash
cd your-project && git-blamebot enable
git add .blamebot && git commit -m 'Initialize blamebot tracking'
```

Creates the `.blamebot/` tracking directory and installs a pre-commit hook that auto-fills reasons when you commit.

## CLI usage

```bash
git blamebot src/main.go                  # all reasons for a file
git blamebot src/main.go -L 42            # most recent reason for a line
git blamebot -L 10:20 src/main.go         # line range
git blamebot --grep "timeout"             # search prompts, reasons & changes
git blamebot --since 2025-02-17           # filter by date
git blamebot --author jens                # filter by author
git blamebot --trace 7                    # show full reasoning trace for record #7
git blamebot --explain src/main.go -L 42  # deep explanation via Sonnet
git blamebot --explain 7                  # explain a specific record by ID
git blamebot --stats                      # summary statistics
git blamebot -v src/main.go               # verbose: diff, hashes, sessions, git blame
```

### Maintenance

```bash
git blamebot --fill-reasons               # fill empty reasons in staged JSONL (runs automatically via pre-commit)
git blamebot --fill-reasons --dry-run     # preview what would be generated
git blamebot --rebuild                    # force SQLite index rebuild
git-blamebot disable                      # remove tracking from this repo
```

## Debugging

```bash
git blamebot --log              # UserPromptSubmit hook log
git blamebot --log --hook       # PostToolUse hook log
git blamebot --dump-payload     # last raw payloads
```

## File layout

```
~/.local/bin/git-blamebot        # single binary (CLI + hooks)

<repo>/.blamebot/                # COMMITTED — travels with repo
├── log/*.jsonl                  # one file per prompt session
├── traces/<session>.json        # extracted thinking/response blocks (portable)
├── .gitattributes               # merge=union for clean merging
└── README

<repo>/.git/blamebot/            # LOCAL ONLY — query cache + debug
├── index.db                     # SQLite (auto-rebuilt from JSONL)
├── current_prompt.json          # ephemeral state between hooks
└── logs/
```

## JSONL record format

```json
{
  "ts": "2026-02-25T14:23:13Z",
  "file": "app/pages/editor/index.php",
  "lines": "5,7",
  "content_hash": "be40cdf0917128af",
  "prompt": "Change all messages to 90s cool kid speak",
  "reason": "Updated error messages to use 90s cool kid slang as requested by the user.",
  "change": "'error' => 'Title is required' → 'error' => 'Title is required, dude!'",
  "tool": "Edit",
  "author": "Jens",
  "session": "9257ef4a-54a7-4600-b3e9-c39b1c6b993c",
  "trace": "/Users/jensr/.claude/projects/test/9257ef4a.jsonl#toolu_01KhbrJWYdB7gw98YRFxW2i5",
  "hunk": {"old_start": 5, "old_lines": 2, "new_start": 5, "new_lines": 2}
}
```

The `reason` field starts empty and is filled by `--fill-reasons` at commit time. The `change` field is always present as a compact diff summary.

## How merging works

Each prompt session writes to its own uniquely-named JSONL file, so two developers (or branches) never touch the same file. Merges are trivial — just new files appearing.

## Building from source

```bash
make build    # build to dist/git-blamebot
make test     # run tests
make install  # build + install + configure hooks
```

Requires Go 1.24+. No CGO — the binary is fully static and cross-compilable.

## Future ideas

See [FUTURE_WORK.md](FUTURE_WORK.md) for potential improvements and features.
